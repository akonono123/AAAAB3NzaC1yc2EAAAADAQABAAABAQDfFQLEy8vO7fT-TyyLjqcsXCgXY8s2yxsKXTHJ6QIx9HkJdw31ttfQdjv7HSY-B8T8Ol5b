<!DOCTYPE html>
<html  xmlns:th="https://thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>

<link rel="stylesheet" th:href="@{/webjars/bootstrap/4.6.0/css/bootstrap.min.css} "/>
<link th:href="@{/webjars/font-awesome/4.7.0/css/font-awesome.min.css}" rel="stylesheet" />
<script type="text/javascript"  th:src="@{/webjars/jquery/3.4.1/jquery.min.js}"></script>
<script type="text/javascript"  th:src="@{/webjars/datatables/1.10.19/js/jquery.dataTables.min.js}"></script>
<link rel="stylesheet" th:href="@{/webjars/datatables/1.10.19/css/jquery.dataTables.min.css} "/>
<script type="text/javascript"  th:src="@{/webjars/bootstrap/4.6.0/js/bootstrap.min.js}"></script>
<!--
<link rel="stylesheet" href="http://cdn.datatables.net/1.10.0/css/jquery.dataTables.css "/>
<script type="text/javascript"  src="http://cdn.datatables.net/1.10.0/js/jquery.dataTables.js"></script>-->
<body>
<a th:href="@{/}">TODO</a>
<hr/>
<br/>

<div class="panel panel-primary">
    <div class="panel-heading"><h2>Users</h2> </div>
    <div class="panel-body ">

        <div class="row" >


            <div class="col-md-4">
                <br/>
                <h3>Form</h3>
                <div id="crud_form" >


                </div>

            </div>

            <div class="col-md-8" align="center">
                <br/>
                <h3>User(s)</h3>
                <table  id="table" class="mdl-data-table display compact table-condensed nowrap" style="width:100%">
                    <thead>
                    <th>Id</th>
                    <th>UserName </th>

                    <th>Active</th>
                    <th></th>
                    <th></th>
                    </thead>
                    <tbody></tbody>
                </table>


            </div>

        </div>
    </div>
</div>
</body>
</html>
<script>
    $(document).ready(function() {
        list();
        loadformADD();
        function loadformADD(){
            $("#crud_form").empty();
            var frm=' <form>\n' +
                /*   '               <div class="form-group">\n' +
                   '                   <label for="itemId">Item ID:</label>\n' +
                   '                   <input type="text" class="form-control" placeholder="Enter Id" name="itemId" id="itemId">\n' +
                   '               </div>\n' +*/
                '               <div class="form-group">\n' +
                '                   <label for="name">UserName:</label>\n' +
                '                   <input type="text" class="form-control" placeholder="Enter username" name="username" id="username" required>\n' +
                '               </div>\n' +
                '               <div class="form-group">\n' +
                '                   <label for="password">Password:</label>\n' +
                '                   <input type="password" class="form-control"  name="password" id="password"  required>\n' +
                '               </div> \n' +
                '               <div class="form-group">\n' +
                '                   <label for="roles">Role:</label>\n' +
                '                <select id="roles"  class="form-control" required></select>\n' +
                '               </div>\n' +
                '\n' +
                '               <button type="submit" class="btn btn-primary" id="add">Submit</button>\n' +
                '           </form>'
            $("#crud_form").append(frm);
            addbtn()
            listroles()
        }
        function loadformEdit(data){
            $("#crud_form").empty();
            console.log(data)
            liststatus(data)
            var frm=' <form>\n' +
                '               <div class="form-group">\n' +
                '                   <input type="text" class="form-control"  name="itemId" id="itemId" value="'+data.id+'" hidden>\n' +
                '               </div>\n' +
                '               <div class="form-group">\n' +
                '                   <label for="name">UserName:</label>\n' +
                '                   <input type="text" class="form-control" value="'+data.username+'" name="username" id="username" required>\n' +
                '               </div>\n' +
                '               <div class="form-group">\n' +
                '                   <label for="password">Password:</label>\n' +
                '                   <input type="password" class="form-control"  value="'+data.password+'" name="password" id="password"  required>\n' +
                '               </div> \n' +
                '               <div class="form-group">\n' +
                '                   <label for="status">Active:</label>\n' +
                '                <select id="status"  class="form-control" required></select>\n' +
                '               </div>\n' +

                '\n' +
                '               <button type="submit" class="btn btn-primary" id="save">Save</button>\n' +
                '           </form>'
            $("#crud_form").append(frm);
            savebtn()
        }

 function listroles(){
           let options=" ";
     $.ajax({
         url: '/getallrolesdata',
         type: "GET",

         success: function (data) {
             options +="<option value=''>Select an account level</option>"
             $.each(data, function (i, roles) {

                 options += "<option value='"+roles.id+"'>"+roles.roleName+"</option>"

             });
            $("#roles").empty();
            $("#roles").append(options);
         }
     });

 }
        function liststatus(data){
            let options=" ";
            $.ajax({
                url: '/seluser/'+ data.id,
                type: "GET",

                success: function (data) {


                    if(data.active == 1){
                        options += "<option value='1' selected>True</option>"
                        options += "<option value='0' >False</option>"
                    }else{
                        options += "<option value='1' >True</option>"
                        options += "<option value='0' selected>False</option>"
                    }



                    $("#status").empty();
                    $("#status").append(options);
                }
            });

        }
        function list(){
            let tabdate=[];

            $.ajax({
                url: '/getalluserdata',
                type: "GET",

                success: function (data) {

                    $.each(data, function (i, user) {

                        tabdate.push({
                            no:i + 1,
                            id:user.id,
                            username:user.username,
                            active:user.active,

                        })

                    });

                    $('#table').dataTable({
                        "data": tabdate,
                        "bDestroy": true,
                        "columns": [
                            { "data": "no" },
                            { "data": "username" },
                            { "data": "active",
                            render:function (data) {
                                if (data == 1){
                                    return '<i class="fa fa-circle " aria-hidden="true" style="color:green"></i>'
                                }else{
                                   return  '<i class="fa fa-circle " aria-hidden="true" style="color:red"></i>'
                                }
                            }
                            },
                            {  "data": "id",
                                "visible":false,
                            },
                            {  "data": null,
                                "defaultContent": "<button class='btn btn-info btn-sm' id='btn1' value='{id}'>Edit</button> <button class='btn btn-danger btn-sm' id='btn2'>Delete</button>"
                            },
                        ]
                    });

                }
            });
            console.log(tabdate)
        }



        $('#table tbody').on('click', '#btn1', function () {
            var id = $(this).closest("tr");
            var ids =  $('#table').DataTable().row(id).data();
            var final=ids["id"]
            seledit(final);
            alert(final)


        });
        $('#table tbody').on('click', '#btn2', function () {
            var id = $(this).closest("tr");
            var ids =  $('#table').DataTable().row(id).data();
            var final=ids["id"]
            deledit(final)



        });

        function seledit(final){
            $("#crud_form").empty();

            $.ajax({
                url: '/seluser/'+ final,
                type: "GET",

                success: function (data) {
                    console.log(data)
                    loadformEdit(data)
                }
            });
        }
        function deledit(final){

            $.ajax({
                url: '/Deleteuser/'+ final,
                type: "GET",

                success: function (data) {
                    alert("success");
                    list();
                }
            });
        }
        function addbtn(){

            $("#add").on("click",function (e) {


                e.preventDefault();
                console.log("btn1");

                var formdata={
                    id:"",
                    username:$("#username").val(),
                    password:$("#password").val(),
                    roleid:$("#roles").val()
                }
                console.log(formdata);
                $.ajax({
                    url: '/Adduser',
                    type: "POST",
                    data:JSON.stringify(formdata),
                    contentType:'application/json',
                    success: function (data) {
                        if(data=="success"){
                            alert("Success");
                            list()

                        }

                    }
                });
            })
        }

        function savebtn(){
            $("#save").on("click",function (a) {
                a.preventDefault();
                console.log("btn2");
                var formdata={
                    id:$("#itemId").val(),
                    username:$("#username").val(),
                    password:$("#password").val(),
                    active:$("#status").val()
                }
                console.log(formdata);
                $.ajax({
                    url: '/Edituser/'+formdata.id,
                    type: "POST",
                    data:JSON.stringify(formdata),
                    contentType:'application/json',
                    success: function (data) {
                        if(data=="success"){
                            alert("Success");
                            list()
                            loadformADD()
                        }

                    }
                });
            })

        }








    } );
</script>
